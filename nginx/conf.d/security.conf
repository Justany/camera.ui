# ===================================
# Configuration de sécurité supplémentaire Nginx
# ===================================

# Bloquer l'accès aux fichiers de sauvegarde et temporaires
location ~ (?:\.(?:bak|conf|dist|fla|in[ci]|log|psd|sh|sql|sw[op])|~)$ {
    deny all;
}

# Empêcher l'exécution de scripts dans les dossiers d'upload
location ~* /(?:uploads|files|recordings)/.*\.(?:php|phtml|php3|php4|php5|pl|py|jsp|asp|aspx|cgi|dll|exe|sh)$ {
    deny all;
    access_log off;
    log_not_found off;
}

# Protection contre les tentatives d'injection SQL
set $block_sql_injections 0;
if ($query_string ~ "union.*select.*\(") {
    set $block_sql_injections 1;
}
if ($query_string ~ "union.*all.*select.*") {
    set $block_sql_injections 1;
}
if ($query_string ~ "concat.*\(") {
    set $block_sql_injections 1;
}
if ($block_sql_injections = 1) {
    return 403;
}

# Protection contre les tentatives de traversée de répertoires
set $block_file_injections 0;
if ($query_string ~ "[a-zA-Z0-9_]=http://") {
    set $block_file_injections 1;
}
if ($query_string ~ "[a-zA-Z0-9_]=(\.\.//?)+") {
    set $block_file_injections 1;
}
if ($query_string ~ "[a-zA-Z0-9_]=/([a-z0-9_.]//?)+") {
    set $block_file_injections 1;
}
if ($block_file_injections = 1) {
    return 403;
}

# Protection contre les tentatives d'exécution de code
set $block_code_injections 0;
if ($query_string ~ "<script.*>.*</script.*>") {
    set $block_code_injections 1;
}
if ($query_string ~ "javascript:") {
    set $block_code_injections 1;
}
if ($query_string ~ "base64_encode.*\(.*\)") {
    set $block_code_injections 1;
}
if ($query_string ~ "eval\(.*\)") {
    set $block_code_injections 1;
}
if ($block_code_injections = 1) {
    return 403;
}

